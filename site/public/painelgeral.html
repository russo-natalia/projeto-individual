<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/estilo-geral.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <title>Abstract | Painel Geral</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="obterDadosGrafico()">
    <!--Menu-->
    <div class="header back-roxo">
        <div class="container">
            <a href="painelgeral.html"><img class="logo" src="img/logo_abstract.png" alt=""></a>
            <ul class="navbar">
                <li class="dropdownBttn"><a href="#">Gráficos</a>
                    <!-- <ul id="dropdownUl">
                        <li> <a href="#navbar_painel">Seus Resultados</a></li>
                        <li><a href="#ranking">Ranking Geral</a></li>
                        <li><a href="#impressionismo">Impressionismo</a></li>
                    </ul> -->
                </li>
                <li><a href="pesquisa.html">Responder Questionário</a></li>
                <li><a href="index.html">Sair</a></li>
            </ul>
        </div>
    </div>
    <div class="divEspacoHeader"></div>
    <!--Conteudo-->
    <div id="painelGeral" class="titulo color-roxo">
        <span>Painel de Gráficos</span>
        <span>Olá, <b id="nome_usuario">Fulana</b></span>
    </div>
    <div id="navbar_painel">
        <a href="#navbar_painel" class="link-painel back-amarelo">Seus Resultados</a>
        <a href="#ranking" class="link-painel back-amarelo">Ranking Geral</a>
        <a href="#impressionismo" class="link-painel back-amarelo">Impressionismo</a>
    </div>

    <div id="resultados_usuario">
        <div class="titulo color-roxo">
            <span>Seus Resultados</span>
        </div>

        <div class="linha-graficos">
            <div id="lista_tentativas">
                <span>Resultado mais frequente: <b id="obra_frequente_usuario" class="color-amarelo">O Almoço dos
                        Barqueiros</b></span>
                <div class="linha"></div>
                <div class="linha-lista-tentativas" style="font-weight: bold;">
                    <span>Tentativas</span>
                    <span>Data</span>
                </div>
                <div id="tentativas_banco_dados">
                    <!-- puxar lista banco -->
                </div>
            </div>
            <div id="grafico_resultados_pizza">
                <!-- grafico pizza -->
                <span class="subtitulo">Resultado das Tentativas</span>
                <canvas id="myChart"></canvas>
            </div>
        </div>
        <div class="linha-graficos">
            <div id="graficos_tentativas_linha">
                <div>
                    <span class="subtitulo">Tentativas x Meses</span>
                    <canvas id="myChart2"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="ranking">
        <div class="titulo color-roxo">
            <span>Ranking Geral</span>
        </div>
        <div class="linha-graficos">
            <div class="cards-kpis">
                <span>Resultado Mais <br> Recorrente</span>
                <h1 class="color-amarelo">
                    <!-- KPI -->
                    O Almoço dos Barqueiros
                </h1>
            </div>
            <div class="cards-kpis">
                <span>Artista Mais <br> Recorrente</span>
                <h1 class="color-amarelo">
                    <!-- KPI -->
                    Claude Monet
                </h1>
            </div>
            <div class="cards-kpis">
                <span>Idade Média <br> de Usuário</span>
                <h1 class="color-amarelo">
                    <!-- KPI -->
                    <span class="kpi-num">26</span>
                </h1>
            </div>
            <div class="cards-kpis">
                <span>Número Médio de Tentativas por Usuário</span>
                <h1>
                    <!-- KPI -->
                    <span class="kpi-num color-amarelo">4</span>
                </h1>
            </div>
        </div>

        <div class="linha-graficos" id="linha-ranking-2">
            <div id="grafico_resultados_pizza">
                <!-- grafico pizza -->
                <span class="subtitulo">Relação de Resultados</span>
                <canvas id="myChart3"></canvas>
            </div>
            <div id="grafico_resultados_pizza">
                <!-- grafico pizza -->
                <span class="subtitulo">Relação de Artistas</span>
                <canvas id="myChart4"></canvas>
            </div>
            <div id="grafico_resultados_pizza">
                <!-- grafico pizza -->
                <span class="subtitulo">Hobbies dos Usuários</span>
                <canvas id="myChart5"></canvas>
            </div>
        </div>
        <div class="linha-graficos" id="linha-ranking-2">
            <div id="grafico_resultados_pizza">
                <!-- grafico pizza -->
                <span class="subtitulo">Características dos Usuários</span>
                <canvas id="myChart6"></canvas>
            </div>
            <div id="grafico_resultados_barra">
                <!-- grafico pizza -->
                <span class="subtitulo">Meses x Resultados</span>
                <canvas id="myChart7"></canvas>
            </div>

        </div>
    </div>
    </div>
    <div id="impressionismo">
        <div class="titulo color-roxo">
            <span>Movimento Impressionista</span>
        </div>
        <div class="bloco-graficos">
            <div class="coluna-graficos">
                <div class="cards-kpis-impressionismo">
                    <span>Artista Com Maior <br> Acervo</span>
                    <h1 class="color-amarelo">
                        <!-- KPI -->
                        Claude Monet
                    </h1>
                </div>
                <div class="cards-kpis-impressionismo">
                    <span>Total de Obras <br> Produzidas</span>
                    <h1 class="color-amarelo">
                        <!-- KPI -->
                        1.323
                    </h1>
                </div>
            </div>
            <div class="coluna-graficos">
                <div id="grafico_resultados_barra">
                    <span class="subtitulo">Artistas x Quantidade de Obras</span>
                    <canvas id="myChart8"></canvas>
                </div>
            </div>
        </div>

    </div>
    </div>



    <div id="rodape">
        <h1>Desenvolvido por Natália Russo</h1>
        <div class="conteudo-rodape">
            <div class="contato">
                <span class="subtitulo">Contato</span><br>
                <span>Telefone: (19) 99728-9318</span><br>
                <span>E-mail: abstract@contato.com</span><br>
                <span>Endereço: Rua Haddock Lobo, 595 - Cerqueira César</span><br>
                <span> São Paulo - SP, 01414-001</span>
                <div class="img-rodape">
                    <a href=""><img src="img/whatsapp.png" alt="WhatsApp"></a>
                    <a href=""><img src="img/instagram.png" alt="Instagram"></a>
                    <a href=""><img src="img/facebook.png" alt="Facebook"></a>
                    <a href=""><img src="img/linkedin.png" alt="LinkedIn"></a>
                </div>
            </div>
            <div class="paginas">
                <span class="subtitulo">Abstract.com.br</span><br>
                <span><a href="index.html">Home</a></span><br>
                <span><a href="saibamais.html">Saiba Mais</a></span><br>
                <span><a href="artistas.html">Artistas</a></span><br>
                <span><a href="faleconosco.html">Fale Conosco</a></span><br>
                <span><a href="sobrenos.html">Sobre Nós</a></span><br>
                <span><a href="login.html">Faça Login</a></span><br>
                <span><a href="cadastro.html">Cadastre-se</a></span><br>
            </div>
        </div>
    </div>
</body>

</html>
<script>
    nome_usuario.innerHTML = sessionStorage.NOME_USUARIO;
    window.onload = obterDadosGrafico();

    // PUXANDO RESULTADOS ILUSTRATIVOS PARA A LISTA DE TENTATIVAS DO USUARIO
    function puxarTentativasBD() {
        var listaTentativasUsuario = [
            'O Almoço dos Barqueiros',
            'O Boulevard Montmartre, no fim da tarde',
            'O Almoço dos Barqueiros'
        ]

        var listaTentativasUsuarioData = [
            '02/05/2023',
            '02/05/2023',
            '04/05/2023'
        ]

        for (var contador = 0; contador < 3; contador++) {
            tentativas_banco_dados.innerHTML += `
       <div class="linha-lista-tentativas">
            <span>${listaTentativasUsuario[contador]}</span>
            <span>${listaTentativasUsuarioData[contador]}</span>
        </div>
    `
        }

    }
    puxarTentativasBD()


    //GRÁFICO DE TENTATIVAS USUARIO PIZZa
    // const ctx = document.getElementById('myChart');

    // new Chart(ctx, {
    //     type: 'pie',
    //     data: {
    //         labels: [
    //             'O Almoço dos Barqueiros',
    //             'O Boulevard Montmartre'
    //         ],
    //         datasets: [{
    //             label: 'Resultados nas Tentativas',
    //             data: [70, 30],
    //             backgroundColor: [
    //                 '#5d91d4e3',
    //                 '#FFC531',
    //             ],
    //             hoverOffset: 4
    //         }]
    //     }
    // });

    //GRÁFICO DE TENTATIVAS USUARIO PIZZa
    const ctx2 = document.getElementById('myChart2');

    new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho'],
            datasets: [{
                label: 'Tentativas x Meses',
                data: [1, 2, 0, 2, 1, 1],
                borderWidth: 1,
                backgroundColor: [
                    '#5d91d4e3',
                    '#5d91d4e3',
                    '#5d91d4e3',
                    '#5d91d4e3',
                    '#5d91d4e3',
                    '#5d91d4e3'
                ],
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    const ctx3 = document.getElementById('myChart3');

    new Chart(ctx3, {
        type: 'pie',
        data: {
            labels: [
                'O Almoço dos Barqueiros',
                'O Boulevard Montmartre'
            ],
            datasets: [{
                label: 'Resultados nas Tentativas',
                data: [70, 30],
                backgroundColor: [
                    '#5d91d4e3',
                    '#FFC531',
                ],
                hoverOffset: 4
            }]
        }
    });

    const ctx4 = document.getElementById('myChart4');

    new Chart(ctx4, {
        type: 'pie',
        data: {
            labels: [
                'O Almoço dos Barqueiros',
                'O Boulevard Montmartre'
            ],
            datasets: [{
                label: 'Resultados nas Tentativas',
                data: [70, 30],
                backgroundColor: [
                    '#5d91d4e3',
                    '#FFC531',
                ],
                hoverOffset: 4
            }]
        }
    });
    const ctx5 = document.getElementById('myChart5');

    new Chart(ctx5, {
        type: 'pie',
        data: {
            labels: [
                'O Almoço dos Barqueiros',
                'O Boulevard Montmartre'
            ],
            datasets: [{
                label: 'Resultados nas Tentativas',
                data: [70, 30],
                backgroundColor: [
                    '#5d91d4e3',
                    '#FFC531',
                ],
                hoverOffset: 4
            }]
        }
    });

    const ctx6 = document.getElementById('myChart6');

    new Chart(ctx6, {
        type: 'pie',
        data: {
            labels: [
                'O Almoço dos Barqueiros',
                'O Boulevard Montmartre'
            ],
            datasets: [{
                label: 'Resultados nas Tentativas',
                data: [70, 30],
                backgroundColor: [
                    '#5d91d4e3',
                    '#FFC531',
                ],
                hoverOffset: 4
            }]
        }
    });

    const ctx7 = document.getElementById('myChart7');

    new Chart(ctx7, {
        type: 'line',
        data: {
            labels: [
                'Janeiro',
                'Fevereiro',
                'Março',
                'Abril',
                'Fevereiro',
                'Junho'
            ],
            datasets: [{
                label: 'Resultados nas Tentativas',
                data: [10, 10, 11, 23, 5, 1],
                backgroundColor: [
                    '#FFC531',
                ],
                hoverOffset: 4
            }]
        }
    });

    const ctx8 = document.getElementById('myChart8');

    new Chart(ctx8, {
        type: 'bar',
        data: {
            labels: [
                'Claude Monet',
                'Pierre-August Renoir',
                'Camile Pissaro',
                'Edgar Degas'
            ],
            datasets: [{
                label: 'Resultados nas Tentativas',
                data: [1000, 700, 400, 230],
                backgroundColor: [
                    '#FFC531',
                ],
                hoverOffset: 4
            }]
        }
    });


    // Gerando o primeiro gráfico
    // let proximaAtualizacao;

    function obterDadosGrafico(idResposta) {

            // alterarTitulo(idResposta)

            // if (proximaAtualizacao != undefined) {
            //     clearTimeout(proximaAtualizacao);
            // // }

            fetch(`/medidas/ultimas/${idResposta}`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        resposta.reverse();

                        plotarGrafico(resposta, idResposta);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                });
    }

// Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
// Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
// A função *plotarGrafico* também invoca a função *atualizarGrafico*
function plotarGrafico(resposta, idResposta) {

console.log('iniciando plotagem do gráfico...');

// Criando estrutura para plotar gráfico - labels
let labels = [];

// Criando estrutura para plotar gráfico - dados
let dados = {
    labels: labels,
    datasets: [{
        label: 'Resposta',
        data: [],
        fill: false,
        backgroundColor: [
            '#FFC531',
            'rgba(255, 197, 49, 0.80)',
            'rgba(255, 197, 49, 0.60)',
            'rgba(255, 197, 49, 0.40)',
            'rgba(255, 197, 49, 0.20)'
        ],
        tension: 0.1
    },
    {
        label: 'Resposta',
        data: [],
        fill: false,
        borderColor: 'rgb(199, 52, 52)',
        tension: 0.1
    }]
};

console.log('----------------------------------------------')
console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
console.log(resposta)

// Inserindo valores recebidos em estrutura para plotar o gráfico
for (i = 0; i < resposta.length; i++) {
    var registro = resposta[i];
    labels.push(registro.resultado);
    dados.datasets[0].data.push(registro.num);
}

console.log('----------------------------------------------')
console.log('O gráfico será plotado com os respectivos valores:')
console.log('Labels:')
console.log(labels)
console.log('Dados:')
console.log(dados.datasets)
console.log('----------------------------------------------')

// Criando estrutura para plotar gráfico - config
const config = {
    type: 'pie',
    data: dados,
};

// Adicionando gráfico criado em div na tela
let myChart = new Chart(
            document.getElementById('myChart'),
            config
);


setTimeout(() => atualizarGrafico(idResposta, dados, myChart), 2000);
}


// Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
// buscando a última medida inserida em tabela contendo as capturas, 

//     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
//     Para ajustar o "select", ajuste o comando sql em src/models
function atualizarGrafico(idResposta, dados, myChart) {



            fetch(`/medidas/tempo-real/${idResposta}`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (novoRegistro) {

                        console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                        console.log(`Dados atuais do gráfico:`);
                        console.log(dados);

                        let avisoCaptura = document.getElementById(`avisoCaptura${idResposta}`)
                        // avisoCaptura.innerHTML = ""


                        if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length]) {
                            console.log("---------------------------------------------------------------")
                            console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                            // avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                            console.log("Horário do novo dado capturado:")
                            console.log(novoRegistro[0].resultado)
                            console.log("Horário do último dado capturado:")
                            console.log(dados.labels[dados.labels.length])
                            console.log("---------------------------------------------------------------")
                        } else {
                            // tirando e colocando valores no gráfico
                            dados.labels.shift(); // apagar o primeiro
                            dados.labels.push(novoRegistro[0].resultado); // incluir um novo momento

                            dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                            dados.datasets[0].data.push(novoRegistro[0].num); // incluir uma nova medida de umidade


                            myChart.update();
                        }

                        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                        // proximaAtualizacao = setTimeout(() => atualizarGrafico(idResposta, dados, myChart), 2000);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    // proximaAtualizacao = setTimeout(() => atualizarGrafico(idResposta, dados, myChart), 2000);
                }
            })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                });

}

</script>